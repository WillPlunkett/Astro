clear
R = [-2429.1, 4555.1, 4577];
V = [-4.7689, -5.6113, 3.0535];
mu = 398600;
coe = coe_from_sv(R, V, mu);
h = coe(1);
e = coe(2);
big_omega = coe(3);
i = coe(4);
small_omega = coe(5);
theta = coe(6);
a = coe(7);
mu = 398600;
T = (2*pi*(a)^(3/2))/(mu^(1/2));
n = 2*pi/T;
E1 = 0;
np=259200/T;
t39 = (np-38)*T;
M39 = n*t39;
E39 = kepler_E(e, M39);
theta39 = (2*pi)+2*atan((((1+e)/(1-e))^.5)*tan((E39)/2));
r = vecnorm(R);
v = vecnorm(V);
R_per = (h^2/(mu*(1+e*cos(theta39))))*[cos(theta39) sin(theta39) 0]';
V_per = (mu/h)*[-sin(theta39) e+cos(theta39) 0]';
J2 = .00108263;
R_earth = 6378;
O_dot = -((3*J2*R_earth^2*mu^.5)/(2*a^(7/2)*(1-e^2)^2))*cos(i);
O39 = big_omega +O_dot*259200;
o_dot = -((3*J2*R_earth^2*mu^.5)/(2*a^(7/2)*(1-e^2)^2))*((5/2)*(sin(i)^2)-2);
o39 = small_omega + o_dot*259200;
M1 = [cos(o39) sin(o39) 0; -sin(o39) cos(o39) 0; 0 0 1];
M2 = [1 0 0; 0 cos(i) sin(i); 0 -sin(i) cos(i)];
M3 = [cos(O39) sin(O39) 0; -sin(O39) cos(O39) 0; 0 0 1];
QXx = M1 * M2 * M3;
QxX = QXx.';
ans_r = QxX*R_per;
ans_v = QxX*V_per;